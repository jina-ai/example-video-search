jtype: Flow
version: '1'
with:
  protocol: 'http'
  cors: True
  port_expose: $JINA_PORT
executors:
  - name: frame_extractor
    uses: jinahub://VideoLoader/v0.1
  - name: text_encoder
    uses: jinahub+docker://AudioCLIPTextEncoder/v0.3
    uses_with:
      traversal_paths: ['r',]
    needs: gateway
  - name: image_encoder
    uses: jinahub+docker://AudioCLIPImageEncoder/v0.3
    uses_with:
      traversal_paths: ['c',]
    needs: frame_extractor
  - name: image_indexer
    uses: jinahub+docker://SimpleIndexer/v0.4
    uses_with:
      match_args:
        limit: $TOP_K
        traversal_rdarray: ['c',]
    uses_metas:
      workspace: $JINA_WORKSPACE
    needs: ['image_encoder', 'text_encoder']
  - name: audio_encoder
    uses: jinahub+docker://AudioCLIPEncoder/v0.3
    uses_with:
      traversal_paths: ['c',]
    needs: frame_extractor
  - name: audio_indexer
    uses: jinahub+docker://SimpleIndexer/v0.4
    uses_with:
      match_args:
        limit: $TOP_K
        traversal_rdarray: ['c',]
    uses_metas:
      workspace: $JINA_WORKSPACE
    needs: ['audio_encoder', 'text_encoder']
  - name: ranker
    uses: MixRanker
    py_module:
      - executors.py
    needs: ['image_indexer', 'audio_indexer']

